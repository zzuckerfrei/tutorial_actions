name: Github Actions Tutorial


on: [push]

env:
  IMAGE_NAME: tutorial-actions
  IMAGE_VERSION: "0.12"

jobs:
  # 여기서 관련 이미지, 컨테이너 삭제
  before:
    name: Before Job
    runs-on: self-hosted
    if: ${{ contains(github.event.head_commit.message, '#dev') || contains(github.event.head_commit.message, '#cicd')}}
    steps:
      - name: check username
        run: whoami
      - name: check pwd
        run: pwd

      - name: Check Duplication
        run: sh /home/admin/test.sh

  build:
    name: Build and push
    runs-on: self-hosted
    needs: before
    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Build Docker image
        run: docker build -t ${{  env.IMAGE_NAME  }} .

      - name: Log in to registry
        run: docker login ${{  secrets.REGISTRY_URL  }} -u ${{  secrets.REGISTRY_USERNAME  }} -p ${{  secrets.REGISTRY_PASSWORD  }}

#      - name: Extract metadata (tags, labels) for Docker
#        id: meta
#        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
#        with:
#          images: ${{ secrets.REGISTRY_URL }}/${{ env.IMAGE_NAME }}

      - name: Set Image Tag
        run: docker tag ${{  env.IMAGE_NAME  }}:${{  env.IMAGE_VERSION  }} ${{  secrets.REGISTRY_URL  }}/${{  env.IMAGE_NAME  }}:${{  env.IMAGE_VERSION  }}

      - name: Push image to registry
        run: docker push ${{  secrets.REGISTRY_URL  }}/${{  env.IMAGE_NAME  }}:${{  env.IMAGE_VERSION  }}

  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: build
    steps:
      - name: Run Container
        run: docker run -itd -p 8888:8080 --name ${{  env.IMAGE_NAME  }} ${{  secrets.REGISTRY_URL  }}/${{  env.IMAGE_NAME  }}:${{  env.IMAGE_VERSION  }}  && echo "=== finish ==="

#  after-deploy:
#    name: After Deploy
#    runs-on: self-hosted
#    needs: deploy
#    steps:
#      - name: replace VAR
#        run: